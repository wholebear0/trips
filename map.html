<!DOCTYPE html>
<html>
<head>
  <title>Trip Map</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Playwrite Font -->
  <link href="https://fonts.googleapis.com/css2?family=Playwrite+NZ+Basic&display=swap" rel="stylesheet">

  <style>
    /* ===== PAGE ===== */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }

    /* ===== TOP RIBBON ===== */
    #top-ribbon {
      width: 100%;
      height: 42px;
      background: #303030;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding: 0 14px;
      box-sizing: border-box;
    }

    .ribbon-btn {
      font-family: "Playwrite NZ Basic", cursive;
      font-size: 14px;
      color: #f5f2e9;
      text-decoration: none;
      padding: 6px 14px;
      border: 1px solid #f5f2e9;
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .ribbon-btn:hover {
      background: #f5f2e9;
      color: #303030;
    }

    /* ===== MAP LAYOUT ===== */
    #map-container {
      width: 100%;
      height: calc(100vh - 42px);
      position: relative;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    /* ===== FILTERS ===== */
    #filters {
      position: absolute;
      top: 10px;              /* below ribbon */
      left: 10px;
      z-index: 999;
      background: white;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    /* ===== POPUP ===== */
    .popup {
      position: absolute;
      transform: translate(-50%, -100%);
      background: #e1e1e1;
      border: 2px solid #5f5f5f;
      border-radius: 10px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.35);
      width: 300px;
      overflow: hidden;
    }

    .popup img {
      width: 100%;
      display: block;
      border-bottom: 1px solid #5f5f5f;
      cursor: pointer;
    }

    .popup-content {
      padding: 10px 12px;
      font-size: 13px;
    }

    /* ===== VIEW DETAILS BUTTON ===== */
    .details-btn {
      display: block;
      width: calc(100% - 24px);
      margin: 10px 12px 14px;
      padding: 8px 10px;
      text-align: center;
      font-family: "Playwrite NZ Basic", cursive;
      font-size: 13px;
      color: #303030;
      background: #f5f2e9;
      border: 1px solid #303030;
      border-radius: 6px;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .details-btn:hover {
      background: #303030;
      color: #f5f2e9;
    }

    .popup-close {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 26px;
      height: 26px;
      font-size: 18px;
      line-height: 22px;
      text-align: center;
      background: white;
      border-radius: 50%;
      border: none;
      cursor: pointer;
    }

    /* ===== MOBILE ===== */
    @media (max-width: 768px) {
      .popup { width: 260px; }
    }
  </style>
</head>

<body>

<!-- ===== TOP RIBBON ===== -->
<div id="top-ribbon">
  <a class="ribbon-btn" href="https://wholebear0.github.io/trips/">
    List
  </a>
</div>

<!-- ===== MAP + FILTER WRAPPER ===== -->
<div id="map-container">

  <div id="filters">
    <label>Type:
      <select id="typeFilter">
        <option value="All">All</option>
        <option value="Hike">Hike</option>
        <option value="Backpack">Backpack</option>
        <option value="Kayak">Kayak</option>
        <option value="Other">Other</option>
      </select>
    </label>
  </div>

  <div id="map"></div>

</div>

<!-- Google Maps -->
<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMCxxUBxZ-a2UyHwu5PbKwYBxvAo0bAAA&callback=initMap">
</script>

<script>
function initMap() {

  const map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 36.805098, lng: -109.822512 },
    zoom: 6,
    mapTypeId: google.maps.MapTypeId.TERRAIN,
    disableDefaultUI: true,
    gestureHandling: "greedy"
  });

  const markers = [];

  function generatePageUrl(title) {
    return "https://sites.google.com/view/wholebear/" +
      title.toLowerCase()
        .replace(/[^\w\s-]/g, "")
        .replace(/\s+/g, "-");
  }

  class Popup extends google.maps.OverlayView {
    constructor(position, data) {
      super();
      this.position = position;
      this.data = data;

      const url = generatePageUrl(data.title);

      this.container = document.createElement("div");
      this.container.className = "popup";

      this.container.innerHTML = `
        <button class="popup-close">×</button>
        ${data.photoUrl ? `<img src="${data.photoUrl}">` : ""}
        <div class="popup-content">
          <p><strong>${data.title}</strong></p>
          <p>${data.area}</p>
          <p>${data.date}</p>
        </div>
        <a class="details-btn" href="${url}" target="_blank">
          View Details
        </a>
      `;

      /* Photo click → trip page */
      const img = this.container.querySelector("img");
      if (img) {
        img.addEventListener("click", () => {
          window.open(url, "_blank");
        });
      }

      this.container.querySelector(".popup-close")
        .addEventListener("click", e => {
          e.stopPropagation();
          this.setMap(null);
        });
    }

    onAdd() {
      this.getPanes().floatPane.appendChild(this.container);
    }

    draw() {
      const point =
        this.getProjection().fromLatLngToDivPixel(this.position);
      this.container.style.left = point.x + "px";
      this.container.style.top = point.y - 12 + "px";
    }

    onRemove() {
      if (this.container.parentNode) {
        this.container.parentNode.removeChild(this.container);
      }
    }
  }

  let activePopup = null;

  function getMarkerIcon(type) {
    switch (type.toLowerCase()) {
      case "hike":
        return "http://maps.google.com/mapfiles/ms/icons/blue-dot.png";
      case "backpack":
        return "http://maps.google.com/mapfiles/ms/icons/red-dot.png";
      case "kayak":
        return "http://maps.google.com/mapfiles/ms/icons/green-dot.png";
      default:
        return "http://maps.google.com/mapfiles/ms/icons/yellow-dot.png";
    }
  }

  async function loadMarkers() {

    const res = await fetch(
      "https://script.google.com/macros/s/AKfycbweollfSW_IlQr6nka0s77-WPu4sIdIDDpmq0Z9NV0egq0c-8dVcO4nevotzZM6jA4T/exec"
    );

    const data = await res.json();

    data.mapMarkers.forEach(d => {

      const marker = new google.maps.Marker({
        position: d.position,
        map,
        icon: getMarkerIcon(d.type)
      });

      marker.tripType = d.type;
      markers.push(marker);

      marker.addListener("click", () => {
        if (activePopup) activePopup.setMap(null);
        activePopup = new Popup(marker.getPosition(), d);
        activePopup.setMap(map);
      });
    });
  }

  loadMarkers();

  /* ===== FILTER ===== */
  document
    .getElementById("typeFilter")
    .addEventListener("change", function () {

      const selected = this.value;

      markers.forEach(marker => {
        if (
          selected === "All" ||
          marker.tripType.toLowerCase() === selected.toLowerCase()
        ) {
          marker.setMap(map);
        } else {
          marker.setMap(null);
        }
      });
    });
}

window.initMap = initMap;
</script>

</body>
</html>
